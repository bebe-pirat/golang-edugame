services:
  - type: web
    name: math-trainer
    env: go
    region: frankfurt  # или другой регион
    buildCommand: |
      go mod download
      go build -o main ./cmd/server/main.go
    startCommand: ./main
    healthCheckPath: /login
    autoDeploy: true
    envVars:
      - key: PORT
        value: 8080
      - key: DATABASE_URL
        fromDatabase:
          name: edugame
          property: connectionString
      - key: ENVIRONMENT
        value: production
    
    # Автоматическое масштабирование
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 70
      targetCPUPercent: 70
    
    # Безопасные заголовки
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Strict-Transport-Security
        value: max-age=31536000; includeSubDomains
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
    
    disk:
      name: data
      mountPath: /data
      sizeGB: 1

databases:
  - name: math-trainer-db
    region: frankfurt
    databaseName: math_trainer
    user: math_trainer_user
    plan: free  
    
    initSQL: |
      -- Здесь можно добавить начальные данные
      CREATE TABLE IF NOT EXISTS init_check (
        id SERIAL PRIMARY KEY,
        created_at TIMESTAMP DEFAULT NOW()
      );