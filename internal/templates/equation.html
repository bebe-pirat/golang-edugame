<html>
  <header>
    <h1>—Ä–µ—à–∞–π —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –¥—É—Ä–∞ </h1>
  </header>
  <body>   
    <h2>–£—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–ª—è {{ .Class }} –∫–ª–∞—Å—Å–∞</h2>
    <p>–í—Å–µ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–π: {{ len .Eqs }}</p>
    
    {{ if eq (len .Eqs) 0 }}
    <p style="color: red;">‚ö†Ô∏è ATTENTION <br> –£—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!</p>
    {{ else }}
    <section class="container">
        <ul class="equations">
            {{ range .Eqs }}
            <li class="equation-item" id="equation-{{ .Id }}">
                <div>
                    <p class="equation-text" data-equation-text="{{ .Eq.Text }}" data-equation-type-id="{{ .Eq.EquationTypeId }}">
                        {{ .Eq.Text }}
                    </p>
                    <input type="text" 
                           class="answer-input" 
                           id="answer-{{ .Id }}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                           data-equation-id="{{ .Id }}">
                    <span class="result" id="result-{{ .Id }}"></span>
                </div>
            </li>
            {{ end }}
        </ul>
        <button id="check-all-button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ</button>
        <span id="overall-result"></span>
    </section>
    {{ end }}

    <script>
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤
        async function checkAllAnswers() {
            const inputs = document.querySelectorAll('.answer-input');
            const answers = [];
            const overallResult = document.getElementById('overall-result');
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
            inputs.forEach(input => {
                const userAnswer = input.value.trim();
                if (userAnswer) {
                    // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å –Ω—É–∂–Ω—ã–º–∏ data-–∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
                    const equationItem = input.closest('.equation-item');
                    const equationTextElement = equationItem.querySelector('.equation-text');
                    
                    answers.push({
                        equation_id: parseInt(input.getAttribute('data-equation-id')),
                        user_answer: userAnswer,
                        equation_text: equationTextElement.getAttribute('data-equation-text'),
                        equation_type_id: parseInt(equationTextElement.getAttribute('data-equation-type-id')),
                    });
                }
            });
            
            if (answers.length === 0) {
                overallResult.textContent = '‚ö†Ô∏è –ù–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏';
                overallResult.style.color = 'orange';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            overallResult.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã...';
            overallResult.style.color = 'gray';
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch('/api/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ answers: answers })
                });
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                const data = await response.json();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                overallResult.textContent = `üìä ${data.overall_feedback}`;
                overallResult.style.color = data.correct > 0 ? 'green' : 'red';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
                data.results.forEach(result => {
                    const input = document.getElementById('answer-' + result.equation_id);
                    const resultSpan = document.getElementById('result-' + result.equation_id);
                    
                    if (result.is_correct) {
                        resultSpan.textContent = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                        resultSpan.style.color = 'green';
                        if (input) input.style.borderColor = 'green';
                    } else {
                        resultSpan.textContent = `‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${result.correct_answer}`;
                        resultSpan.style.color = 'red';
                        if (input) input.style.borderColor = 'red';
                    }
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                overallResult.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ';
                overallResult.style.color = 'red';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ"
        document.getElementById('check-all-button').addEventListener('click', checkAllAnswers);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
        document.addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement.classList.contains('answer-input')) {
                    const equationId = activeElement.getAttribute('data-equation-id');
                    await checkAnswer(equationId);
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—é
                    const nextId = parseInt(equationId) + 1;
                    const nextInput = document.getElementById('answer-' + nextId);
                    if (nextInput) {
                        nextInput.focus();
                    }
                }
            }
        });
    </script>
  </body>
</html>
