<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ—à–∞–π –ø—Ä–∏–º–µ—Ä—ã!</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="equation-header">
            <h1><i class="fas fa-calculator"></i> –†–µ—à–∞–π –ø—Ä–∏–º–µ—Ä—ã!</h1>
            <div class="class-info">
                <p>–ö–ª–∞—Å—Å: <strong>{{ .Class }}</strong></p>
                <p>–í—Å–µ–≥–æ –ø—Ä–∏–º–µ—Ä–æ–≤: <strong>{{ len .Eqs }}</strong></p>
            </div>
            <nav> 
                <div class="nav-links">
                    <a href="/logout">–í—ã–π—Ç–∏</a>
                </div>
            </nav>
        </header>
        
        {{ if eq (len .Eqs) 0 }}
        <div class="no-equations">
            <i class="fas fa-exclamation-triangle fa-3x"></i>
            <h2>–ü—Ä–∏–º–µ—Ä—ã –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!</h2>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ</p>
            <a href="/home" class="btn btn-primary mt-20">
                <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
        </div>
        {{ else }}
        <div class="equations-container">
            <ul class="equations-list">
                {{ range .Eqs }}
                <li class="equation-item" id="equation-{{ .Id }}">
                    <div class="equation-text" 
                         data-equation-text="{{ .Eq.Text }}" 
                         data-equation-type-id="{{ .Eq.EquationTypeId }}">
                        {{ .Eq.Text }} 
                    </div>
                    
                    <div class="answer-section">
                        <input type="text" 
                               class="answer-input" 
                               id="answer-{{ .Id }}" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                               data-equation-id="{{ .Id }}"
                               autocomplete="off">
                        
                        <span class="result" id="result-{{ .Id }}"></span>
                    </div>
                </li>
                {{ end }}
            </ul>
            
            <div class="text-center">
                <button id="check-all-button" class="btn btn-success btn-large">
                    <i class="fas fa-check-double"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
                </button>
            </div>
            
            <div class="overall-result" id="overall-result"></div>
        </div>
        {{ end }}
        
        <div class="actions-panel">
            <a href="/home" class="btn btn-primary">
                <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
            <a href="/stats" class="btn btn-secondary">
                <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </a>
            {{ if gt (len .Eqs) 0 }}
            <button onclick="window.location.reload()" class="btn btn-secondary">
                <i class="fas fa-redo"></i> –ù–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
            </button>
            {{ end }}
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤
        async function checkAllAnswers() {
            const inputs = document.querySelectorAll('.answer-input');
            const answers = [];
            const overallResult = document.getElementById('overall-result');
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã, –≤–∫–ª—é—á–∞—è –ø—É—Å—Ç—ã–µ
            inputs.forEach(input => {
                const userAnswer = input.value.trim();
                const equationId = input.getAttribute('data-equation-id');
                const equationItem = document.getElementById('equation-' + equationId);
                const equationTextElement = equationItem.querySelector('.equation-text');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–°–ï —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –¥–∞–∂–µ —Å –ø—É—Å—Ç—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
                answers.push({
                    equation_id: parseInt(equationId),
                    user_answer: userAnswer, // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
                    equation_text: equationTextElement.getAttribute('data-equation-text'),
                    equation_type_id: parseInt(equationTextElement.getAttribute('data-equation-type-id')),
                });
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            overallResult.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã...';
            overallResult.style.color = '#6c757d';
            overallResult.style.background = '#f8f9fa';
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø–æ–ª—è
            inputs.forEach(input => input.disabled = true);
            
            try {
                const response = await fetch('/api/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        answers: answers,
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö
                        check_all: true 
                    })
                });
                
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                overallResult.textContent = `üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: ${data.overall_feedback}`;
                overallResult.style.background = data.correct > 0 ? '#d4edda' : '#f8d7da';
                overallResult.style.color = data.correct > 0 ? '#155724' : '#721c24';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞
                if (data.results) {
                    data.results.forEach(result => {
                        const input = document.getElementById('answer-' + result.equation_id);
                        const resultSpan = document.getElementById('result-' + result.equation_id);
                        
                        if (result.status === 'correct') {
                            // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                            resultSpan.textContent = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                            resultSpan.className = 'result correct';
                            if (input) input.style.borderColor = '#2ecc71';
                        } else if (result.status === 'incorrect') {
                            // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                            resultSpan.textContent = `‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${result.correct_answer}`;
                            resultSpan.className = 'result incorrect';
                            if (input) input.style.borderColor = '#e74c3c';
                        } else if (result.status === 'skipped') {
                            // –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π (–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)
                            resultSpan.textContent = '‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ';
                            resultSpan.className = 'result skipped';
                            if (input) {
                                input.style.borderColor = '#ffc107';
                                input.style.background = '#fff3cd';
                            }
                        }
                    });
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
                const correctCount = data.correct || 0;
                const incorrectCount = data.incorrect || 0;
                const skippedCount = data.skipped || 0;
                const answeredCount = correctCount + incorrectCount;
                const totalCount = inputs.length;
                
                let notificationText = '';
                if (skippedCount === totalCount) {
                    notificationText = `–í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –≤—Å–µ ${totalCount} –ø—Ä–∏–º–µ—Ä–æ–≤`;
                } else if (answeredCount === 0) {
                    notificationText = `–í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã (${skippedCount})`;
                } else {
                    const percentage = Math.round(correctCount / answeredCount * 100);
                    notificationText = `–ü—Ä–∞–≤–∏–ª—å–Ω–æ ${correctCount} –∏–∑ ${answeredCount} (${percentage}%), –ø—Ä–æ–ø—É—â–µ–Ω–æ: ${skippedCount}`;
                }
                
                showNotification(notificationText, 
                    correctCount === answeredCount && answeredCount > 0 ? 'success' : 
                    skippedCount === totalCount ? 'warning' : 'info');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                overallResult.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ';
                overallResult.style.background = '#f8d7da';
                overallResult.style.color = '#721c24';
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            } finally {
                // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø–æ–ª—è
                inputs.forEach(input => input.disabled = false);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ"
            const checkAllBtn = document.getElementById('check-all-button');
            if (checkAllBtn) {
                checkAllBtn.addEventListener('click', checkAllAnswers);
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Enter –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement.classList.contains('answer-input')) {
                        const equationId = activeElement.getAttribute('data-equation-id');
                        checkAnswer(equationId);
                        
                        // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—é
                        const nextId = parseInt(equationId) + 1;
                        const nextInput = document.getElementById('answer-' + nextId);
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                }
            });
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ
            const firstInput = document.querySelector('.answer-input');
            if (firstInput) {
                firstInput.focus();
            }
        });
    </script>
</body>
</html>